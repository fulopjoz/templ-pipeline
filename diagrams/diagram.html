
<!DOCTYPE html>
<html>
<head>
    <title>Protein Superimposition Workflow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: white;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="mermaid">

flowchart TD
    Start([transform_ligand]) --> Load[Load Protein Structures]
    Load --> Filter[Filter Amino Acids]
    Filter --> Validate[Validate & Select Chains]
    Validate --> CheckAtoms{Enough CA Atoms?}
    
    CheckAtoms -->|No| Fail[Return None]
    CheckAtoms -->|Yes| Level1[Level 1: Homologous Alignment]
    
    Level1 --> CheckLength{Sequence Length Similar?}
    CheckLength -->|No| Level2[Level 2: Sequence Alignment]
    CheckLength -->|Yes| TryHomologs[Try superimpose_homologs]
    
    TryHomologs --> CheckAnchors{Sufficient Anchors?}
    CheckAnchors -->|No| Level2
    CheckAnchors -->|Yes| CalcRMSD[Calculate CA RMSD]
    
    Level2 --> CheckSeq{Sequence Alignment Success?}
    CheckSeq -->|No| Level3[Level 3: 3Di Structural]
    CheckSeq -->|Yes| CalcRMSD
    
    Level3 --> Check3Di{3Di Available & Success?}
    Check3Di -->|No| Level4[Level 4: Centroid Fallback]
    Check3Di -->|Yes| CalcRMSD
    
    Level4 --> CheckMin{Min Atoms Available?}
    CheckMin -->|No| Fail
    CheckMin -->|Yes| SimpleAlign[Simple Superimposition]
    SimpleAlign --> CalcRMSD
    
    CalcRMSD --> CheckThreshold{CA RMSD <= Threshold?}
    CheckThreshold -->|No| Fallback[Apply Fallback Thresholds]
    CheckThreshold -->|Yes| Transform[Transform Ligand Coordinates]
    
    Fallback --> CheckTemplates{Any Templates Pass?}
    CheckTemplates -->|No| BestTemplate[Use Best Available Template]
    CheckTemplates -->|Yes| Transform
    
    Transform --> ApplyMatrix[Apply Transformation Matrix]
    ApplyMatrix --> ValidateBonds[Validate Bond Lengths]
    ValidateBonds --> AddMetadata[Add Metadata Properties]
    AddMetadata --> Success[Return Transformed Ligand]
    
    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    
    class Start,Success startEnd
    class Load,Filter,Validate,Level1,Level2,Level3,Level4,TryHomologs,CalcRMSD,Transform,ApplyMatrix,ValidateBonds,AddMetadata,SimpleAlign process
    class CheckAtoms,CheckLength,CheckAnchors,CheckSeq,Check3Di,CheckMin,CheckThreshold,CheckTemplates decision
    class Fail error
    class Fallback,BestTemplate process

    </div>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
