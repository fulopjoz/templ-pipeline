<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCS Workflow - Updated from Code</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.9.0/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #000000;
            background: #ffffff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 12px 40px rgba(0,0,0,0.15);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 50px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 300;
            margin-bottom: 15px;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .content {
            padding: 50px;
        }
        
        .diagram-section {
            margin-bottom: 60px;
        }
        
        .section-title {
            font-size: 2.2em;
            color: #2c3e50;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 4px solid #3498db;
            font-weight: 400;
        }
        
        .mermaid {
            text-align: center;
            margin: 40px 0;
            padding: 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 16px;
            border: 2px solid #dee2e6;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .reference-section {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 50px;
            border-radius: 16px;
            margin-top: 50px;
        }
        
        .reference-section h2 {
            color: white;
            margin-bottom: 40px;
            font-size: 2.2em;
            font-weight: 300;
        }
        
        .function-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }
        
        .function-card {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 12px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .function-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        
        .function-card h3 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 2px solid rgba(52, 152, 219, 0.3);
            padding-bottom: 10px;
        }
        
        .function-card ul {
            margin: 20px 0;
            padding-left: 25px;
        }
        
        .function-card li {
            margin: 12px 0;
            line-height: 1.6;
        }
        
        .function-card strong {
            color: #3498db;
        }
        
        .workflow-features {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 12px;
            margin-top: 40px;
        }
        
        .workflow-features h3 {
            color: #3498db;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        
        .workflow-features ul {
            margin: 20px 0;
            padding-left: 25px;
        }
        
        .workflow-features li {
            margin: 12px 0;
            line-height: 1.6;
        }
        
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 40px;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            font-size: 0.95em;
            font-weight: 500;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MCS Workflow</h1>
        </div>
        
        <div class="content">
            <div id="diagram" class="diagram-section">
                <h2 class="section-title">MCS Workflow Diagram</h2>
                <p style="margin-bottom: 30px; color: #555; font-size: 1.1em;">
                    The diagram below shows the complete MCS workflow for template-based pose prediction, 
                    based on the actual implementation in mcs.py.
                </p>
                
                <div class="mermaid">
flowchart TD
    Start["find_mcs<br/>Primary MCS Finder"] --> Input["Input Target & References<br/>tgt: Chem.Mol, refs: List[Chem.Mol]"]
    Input --> LogSizes["Log Molecule Sizes<br/>target_atoms, max_template_atoms"]
    LogSizes --> SetupRascal["RascalMCES Setup<br/>opts.singleLargestFrag = True<br/>opts.similarityThreshold = 0.9"]
    
    SetupRascal --> ThresholdLoop["Threshold Reduction Loop<br/>0.9 to 0.0 in 0.1 steps"]
    ThresholdLoop --> SearchLoop["Search MCS for Each Template<br/>rdRascalMCES.FindMCES()"]
    
    SearchLoop --> CheckMCR{"MCES Found?"}
    CheckMCR -->|No| NextTemplate["Next Template"]
    CheckMCR -->|Yes| ExtractMCS["Extract MCS Details<br/>atom_matches, bond_matches, smarts"]
    
    NextTemplate --> CheckMoreTemplates{"More Templates?"}
    CheckMoreTemplates -->|Yes| SearchLoop
    CheckMoreTemplates -->|No| ReduceThreshold["Reduce Threshold<br/>opts.similarityThreshold -= 0.1"]
    
    ExtractMCS --> StoreHit["Store Hit Details<br/>size, template_idx, smarts, mcs_info"]
    StoreHit --> NextTemplate
    
    ReduceThreshold --> CheckThreshold{"Threshold >= 0.0?"}
    CheckThreshold -->|Yes| ThresholdLoop
    CheckThreshold -->|No| CheckHits{"Any Hits Found?"}
    
    CheckHits -->|Yes| FindBest["Find Best Match by Size<br/>max(hits, key=lambda x: x[0])"]
    CheckHits -->|No| CentralFallback["Central Atom Fallback<br/>find_best_ca_rmsd_template()"]
    
    FindBest --> QualityCheck{"Quality Check<br/>best_size >= 5 OR threshold <= 0.2"}
    QualityCheck -->|Accept| ReturnMCS["Return Best MCS<br/>idx, smarts, details"]
    QualityCheck -->|Reject| ReduceThreshold
    
    CentralFallback --> ReturnCentral["Return Central Atom<br/>best_template_idx, '*', central_details"]
    
    ReturnMCS --> ConstrainedEmbed["constrained_embed<br/>Generate conformers with MCS constraints"]
    ReturnCentral --> CentralEmbed["central_atom_embed<br/>Fallback embedding using central atom"]
    
    ConstrainedEmbed --> CheckSMARTS{"SMARTS == '*'?"}
    CheckSMARTS -->|Yes| CentralEmbed
    CheckSMARTS -->|No| MCSMatch["MCS Pattern Match<br/>Chem.MolFromSmarts(smarts)"]
    
    MCSMatch --> ValidateMatch{"Valid Match?<br/>len(tgt_idxs) >= 3"}
    ValidateMatch -->|No| CentralEmbed
    ValidateMatch -->|Yes| BuildCoordMap["Build Coordinate Map<br/>Map MCS atoms to template coords"]
    
    BuildCoordMap --> LogCoords["Log Coordinate Map<br/>log_coordinate_map()"]
    LogCoords --> RelaxConstraints["Relax Close Constraints<br/>relax_close_constraints()"]
    
    RelaxConstraints --> CheckConstraints{"Enough Constraints?<br/>len(coordMap) >= 3"}
    CheckConstraints -->|No| CentralEmbed
    CheckConstraints -->|Yes| EmbedSetup["ETKDGv3 Setup<br/>ps.randomSeed = 42<br/>ps.numThreads = 1"]
    
    EmbedSetup --> GenerateConfs["Generate Conformers<br/>rdDistGeom.EmbedMultipleConfs()"]
    GenerateConfs --> CheckConfs{"Conformers Generated?"}
    CheckConfs -->|No| ProgressiveReduction["Progressive Constraint Reduction<br/>Reduce constraints until success"]
    CheckConfs -->|Yes| PostAlignment["Post-Embedding Alignment<br/>rdMolAlign.AlignMol()"]
    
    ProgressiveReduction --> EmbedSetup
    PostAlignment --> GeometryValidation["Geometry Validation<br/>validate_molecular_geometry()"]
    
    GeometryValidation --> OptimizationCheck{"Enable Optimization?<br/>enable_optimization parameter"}
    OptimizationCheck -->|Yes| ApplyOptimization["Simple Minimization<br/>simple_minimize_molecule()"]
    OptimizationCheck -->|No| SkipOptimization["Skip Optimization<br/>ETKDGv3 sufficient"]
    
    ApplyOptimization --> FinalValidation["Final Validation<br/>validate_molecular_connectivity()"]
    SkipOptimization --> FinalValidation
    FinalValidation --> Success["Return Optimized Molecule<br/>With conformers and metadata"]
    
    CentralEmbed --> CentralSetup["Central Atom Setup<br/>get_central_atom()"]
    CentralSetup --> UnconstrainedEmbed["Unconstrained Embedding<br/>embed_with_uff_fallback()"]
    UnconstrainedEmbed --> PositionAtCenter["Position at Reference Center<br/>Translate to template center"]
    PositionAtCenter --> CentralOptimization{"Enable Optimization?"}
    CentralOptimization -->|Yes| ApplyCentralOptimization["Central Atom Optimization<br/>simple_minimize_molecule()"]
    CentralOptimization -->|No| CentralFinalValidation["Central Atom Validation<br/>validate_molecular_connectivity()"]
    ApplyCentralOptimization --> CentralFinalValidation
    CentralFinalValidation --> Success
    
    classDef startEnd fill:#2ecc71,stroke:#27ae60,stroke-width:3px,color:#000
    classDef process fill:#3498db,stroke:#2980b9,stroke-width:2px,color:#000
    classDef decision fill:#f39c12,stroke:#e67e22,stroke-width:2px,color:#000
    classDef error fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#000
    classDef success fill:#27ae60,stroke:#229954,stroke-width:3px,color:#000
    classDef mcs fill:#9b59b6,stroke:#8e44ad,stroke-width:2px,color:#000
    classDef embedding fill:#e67e22,stroke:#d35400,stroke-width:2px,color:#000
    classDef optimization fill:#1abc9c,stroke:#16a085,stroke-width:2px,color:#000
    classDef validation fill:#34495e,stroke:#2c3e50,stroke-width:2px,color:#000
    classDef fallback fill:#e74c3c,stroke:#c0392b,stroke-width:2px,color:#000
    
    class Start,Success startEnd
    class Input,LogSizes,SetupRascal,ThresholdLoop,SearchLoop,ExtractMCS,StoreHit,FindBest,ReturnMCS,ReturnCentral,BuildCoordMap,LogCoords,RelaxConstraints,EmbedSetup,GenerateConfs,PostAlignment,FinalValidation process
    class CheckMCR,CheckMoreTemplates,CheckThreshold,CheckHits,QualityCheck,CheckSMARTS,ValidateMatch,CheckConstraints,CheckConfs,OptimizationCheck,CentralOptimization decision
    class NextTemplate,ReduceThreshold,CentralFallback,CentralEmbed,CentralSetup,UnconstrainedEmbed,PositionAtCenter,ApplyCentralOptimization,CentralFinalValidation fallback
    class MCSMatch,ConstrainedEmbed mcs
    class EmbedSetup,GenerateConfs,PostAlignment embedding
    class ApplyOptimization,ApplyCentralOptimization optimization
    class GeometryValidation,FinalValidation,CentralFinalValidation validation
                </div>
            </div>
            
            <div id="reference" class="reference-section">
                <h2>Function Reference Table</h2>
                <p style="margin-bottom: 30px; opacity: 0.9; font-size: 1.1em;">
                    Comprehensive reference of all functions used in the MCS workflow, 
                    with detailed descriptions of what each function actually does.
                </p>
                
                <div class="function-grid">
                    <div class="function-card">
                        <h3>Core MCS Finding Functions</h3>
                        <ul>
                            <li><strong>find_mcs()</strong>: Orchestrates the entire MCS search process using RascalMCES exclusively. Implements progressive threshold reduction from 0.9 to 0.0 in 0.1 steps, with quality control that rejects small matches unless at low thresholds. Falls back to central atom positioning when all MCS attempts fail.</li>
                            <li><strong>get_central_atom()</strong>: Calculates the most central atom in a molecule by finding the atom with the smallest sum of shortest paths to all other atoms. Uses RDKit's distance matrix to determine centrality, breaking ties by returning the first atom with minimum path sum.</li>
                            <li><strong>find_best_ca_rmsd_template()</strong>: Selects the template with the lowest CA RMSD value from a list of reference molecules. Parses the "ca_rmsd" property from each template and returns the index of the template with the smallest RMSD value, defaulting to index 0 if no RMSD data is available.</li>
                            <li><strong>rdRascalMCES.FindMCES()</strong>: Performs the actual maximum common edge substructure search using the RascalMCES algorithm. Takes target and reference molecules with similarity threshold options, returning MCES objects containing atom matches, bond matches, and SMARTS strings representing the common substructure.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Conformer Generation Functions</h3>
                        <ul>
                            <li><strong>constrained_embed()</strong>: Generates conformers while locking MCS atoms to template coordinates. Builds a coordinate map from MCS atom matches, validates the map, relaxes close constraints, and uses ETKDGv3 with single-threaded execution to prevent memory issues. Includes post-embedding alignment and optional force field optimization.</li>
                            <li><strong>central_atom_embed()</strong>: Fallback embedding method that positions the target molecule's central atom at the reference molecule's central atom position. Uses unconstrained embedding with UFF fallback, then translates all conformers to align central atoms. Includes optional force field optimization and geometry validation.</li>
                            <li><strong>embed_with_uff_fallback()</strong>: Robust conformer generation with automatic detection of organometallic molecules. Uses standard ETKDGv3 first, then falls back to UFF-compatible settings for organometallics, and finally minimal parameters for difficult molecules. Implements thread limiting and adaptive conformer counts.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Molecular Validation Functions</h3>
                        <ul>
                            <li><strong>validate_molecular_connectivity()</strong>: Checks for molecular fragmentation and unreasonable atom positions after processing. Uses RDKit's GetMolFrags to detect disconnected fragments and validates atom coordinates are within reasonable bounds (less than 1000Å). Returns False if connectivity is broken or atoms have invalid positions.</li>
                            <li><strong>validate_molecular_geometry()</strong>: Validates molecular geometry by checking bond lengths and connectivity. Calculates all bond distances and flags suspicious bonds outside the 0.5-3.0Å range. Provides detailed logging of geometry statistics and returns False if molecular distortion is detected.</li>
                            <li><strong>log_coordinate_map()</strong>: Debugging function that logs detailed information about coordinate constraints used for embedding. Calculates distances between constraint pairs and flags problematic constraints that are too close (< 1.0Å) or too distant (> 20.0Å). Helps diagnose embedding failures.</li>
                            <li><strong>relax_close_constraints()</strong>: Removes coordinate constraints that are too close together to prevent embedding failures. Finds constraint pairs closer than the minimum distance (default 1.0Å) and removes the constraint with higher atom index, keeping the more central constraint. Returns the relaxed coordinate map.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Force Field Optimization Functions</h3>
                        <ul>
                            <li><strong>simple_minimize_molecule()</strong>: Performs unconstrained force field minimization using MMFF with UFF fallback. Automatically detects organometallic molecules and switches to UFF optimization. Handles both single and multiple conformer optimization, returning True if at least one conformer converges successfully.</li>
                            <li><strong>validate_mmff_parameters()</strong>: Checks if MMFF force field parameters are available for all atoms in the molecule. Uses MMFFGetMoleculeProperties and MMFFHasAllMoleculeParams to verify parameter availability. Returns False for molecules with missing MMFF parameters, triggering UFF fallback.</li>
                            <li><strong>needs_uff_fallback()</strong>: Detects molecules that require UFF fallback due to organometallic atoms or missing MMFF parameters. Checks for transition metals and metalloids in the periodic table and validates MMFF parameter availability. Returns True if UFF fallback is needed.</li>
                            <li><strong>AllChem.MMFFOptimizeMolecule()</strong>: RDKit's MMFF force field optimization function. Optimizes molecular geometry using the MMFF94s force field. Returns convergence status (0 for success) and can handle both single conformer and multiple conformer optimization.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Molecular Alignment Functions</h3>
                        <ul>
                            <li><strong>rdMolAlign.AlignMol()</strong>: RDKit's molecular alignment function that superimposes molecules based on atom correspondences. Uses the atom map from MCS matches to align the target molecule to the reference template. Performs rigid body transformation to minimize RMSD between corresponding atoms.</li>
                            <li><strong>Chem.GetSubstructMatch()</strong>: Finds substructure matches between molecules using SMARTS patterns. Returns atom indices that match the SMARTS pattern in the target molecule. Used to identify MCS atoms for coordinate mapping and alignment.</li>
                            <li><strong>Chem.MolFromSmarts()</strong>: Converts SMARTS string to RDKit molecular pattern object. Validates SMARTS syntax and creates a pattern that can be used for substructure matching. Returns None if SMARTS is invalid, triggering fallback to central atom positioning.</li>
                            <li><strong>Chem.AddHs()</strong>: Adds hydrogen atoms to molecules with coordinates. Preserves existing conformer coordinates while adding hydrogens. Essential for accurate molecular representation and force field calculations.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Utility Functions</h3>
                        <ul>
                            <li><strong>safe_name()</strong>: Converts molecule names or strings to filesystem-safe versions. Extracts names from molecule properties or uses provided strings, then replaces problematic characters with underscores. Removes multiple underscores and trims leading/trailing underscores.</li>
                            <li><strong>N_CONFS = 200</strong>: Default number of conformers to generate during embedding. Can be overridden by function parameters and is adaptively reduced for large molecules or fallback scenarios.</li>
                            <li><strong>MAX_MOLECULE_SIZE = 150</strong>: Maximum molecule size for constrained embedding. Molecules larger than this threshold automatically use central atom fallback to prevent computational issues.</li>
                            <li><strong>MIN_MCS_SIZE = 3</strong>: Minimum acceptable MCS size for constrained embedding. MCS matches with fewer than 3 atoms fall back to central atom positioning.</li>
                        </ul>
                    </div>
                    
                    <div class="function-card">
                        <h3>Advanced Features</h3>
                        <ul>
                            <li><strong>Progressive Threshold Reduction</strong>: RascalMCES similarity threshold reduction from 0.9 to 0.0 in 0.1 steps. Quality control rejects small matches unless at low thresholds (≤ 0.2), ensuring robust MCS finding across diverse molecular structures.</li>
                            <li><strong>Organometallic Detection</strong>: Automatic detection of transition metals and metalloids requiring UFF fallback. Checks atomic numbers for Sc-Zn, Y-Cd, La, Hf-Hg, Ac, and Rf-Cn series to identify organometallic compounds.</li>
                            <li><strong>Memory Management</strong>: Thread limiting and resource control to prevent memory allocation errors. Uses single-threaded conformer generation and adaptive conformer counts based on molecule size and complexity.</li>
                            <li><strong>Quality Control</strong>: Multi-stage validation including connectivity checks, geometry validation, bond length verification, and convergence monitoring. Comprehensive error handling with detailed logging for debugging.</li>
                        </ul>
                    </div>
                </div>
                
                <div id="workflow" class="workflow-features">
                    <h3>Workflow Features & Quality Control</h3>
                    <ul>
                        <li><strong>Progressive Threshold Reduction</strong>: RascalMCES with similarity threshold reduction from 0.9 to 0.0 in 0.1 steps, with quality control that rejects small matches unless at low thresholds (≤ 0.2)</li>
                        <li><strong>Central Atom Fallback</strong>: Single atom positioning when MCS fails, using the atom with smallest sum of shortest paths to all other atoms as the central reference point</li>
                        <li><strong>Constrained Embedding</strong>: Lock MCS atoms to template coordinates using coordinate maps, with constraint relaxation to prevent embedding failures</li>
                        <li><strong>Geometry Validation</strong>: Comprehensive bond length checks (0.5-3.0Å range) and molecular connectivity validation to ensure reasonable molecular geometry</li>
                        <li><strong>Force Field Optimization</strong>: MMFF with automatic UFF fallback for organometallic molecules, including convergence monitoring and validation</li>
                        <li><strong>Memory Management</strong>: Thread limiting and resource control to prevent memory allocation errors in benchmarking environments</li>
                        <li><strong>Error Tracking</strong>: Comprehensive error categorization and logging with detailed diagnostics for debugging embedding and optimization failures</li>
                    </ul>
                </div>
                
                <div id="legend" class="color-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>Start/End Points</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Process Steps</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #f39c12;"></div>
                        <span>Decision Points</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #9b59b6;"></div>
                        <span>MCS Operations</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e67e22;"></div>
                        <span>Embedding Steps</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #1abc9c;"></div>
                        <span>Optimization</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #34495e;"></div>
                        <span>Validation</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Fallback/Error</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis',
                nodeSpacing: 60,
                rankSpacing: 60
            }
        });
    </script>
</body>
</html> 