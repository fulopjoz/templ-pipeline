<!DOCTYPE html>
<html>
<head>
    <title>Protein Superimposition Workflow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .mermaid {
            text-align: center;
            margin: 20px 0;
        }
        .description {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Protein Superimposition Workflow with Fallback Strategy</h1>
        
        <div class="mermaid">
flowchart TD
    Start([transform_ligand]) --> Load[Load Protein Structures]
    Load --> Filter[Filter Amino Acids]
    Filter --> Validate[Validate & Select Chains]
    Validate --> CheckAtoms{Enough CA Atoms?}
    
    CheckAtoms -->|No| Fail[Return None]
    CheckAtoms -->|Yes| Level1[Level 1: Homologous Alignment]
    
    Level1 --> CheckLength{Sequence Length Similar?}
    CheckLength -->|No| Level2[Level 2: Sequence Alignment]
    CheckLength -->|Yes| TryHomologs[Try superimpose_homologs]
    
    TryHomologs --> CheckAnchors{Sufficient Anchors?}
    CheckAnchors -->|No| Level2
    CheckAnchors -->|Yes| CalcRMSD[Calculate CA RMSD]
    
    Level2 --> CheckSeq{Sequence Alignment Success?}
    CheckSeq -->|No| Level3[Level 3: 3Di Structural]
    CheckSeq -->|Yes| CalcRMSD
    
    Level3 --> Check3Di{3Di Available & Success?}
    Check3Di -->|No| Level4[Level 4: Centroid Fallback]
    Check3Di -->|Yes| CalcRMSD
    
    Level4 --> CheckMin{Min Atoms Available?}
    CheckMin -->|No| Fail
    CheckMin -->|Yes| SimpleAlign[Simple Superimposition]
    SimpleAlign --> CalcRMSD
    
    CalcRMSD --> CheckThreshold{CA RMSD <= Threshold?}
    CheckThreshold -->|No| Fallback[Apply Fallback Thresholds]
    CheckThreshold -->|Yes| Transform[Transform Ligand Coordinates]
    
    Fallback --> CheckTemplates{Any Templates Pass?}
    CheckTemplates -->|No| BestTemplate[Use Best Available Template]
    CheckTemplates -->|Yes| Transform
    
    Transform --> ApplyMatrix[Apply Transformation Matrix]
    ApplyMatrix --> ValidateBonds[Validate Bond Lengths]
    ValidateBonds --> AddMetadata[Add Metadata Properties]
    AddMetadata --> Success[Return Transformed Ligand]
    
    %% Styling
    classDef startEnd fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef decision fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef success fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    
    class Start,Success startEnd
    class Load,Filter,Validate,Level1,Level2,Level3,Level4,TryHomologs,CalcRMSD,Transform,ApplyMatrix,ValidateBonds,AddMetadata,SimpleAlign process
    class CheckAtoms,CheckLength,CheckAnchors,CheckSeq,Check3Di,CheckMin,CheckThreshold,CheckTemplates decision
    class Fail error
    class Fallback,BestTemplate process
        </div>
        
        <div class="description">
            <h3>Key Functions Used in Protein Superimposition:</h3>
            <h4>Main Functions:</h4>
            <ol>
                <li><strong>transform_ligand()</strong> - Primary orchestrator function</li>
                <li><strong>superimpose_homologs()</strong> - Level 1: homologous alignment</li>
                <li><strong>superimpose()</strong> - Basic superimposition (used in fallbacks)</li>
                <li><strong>_align_with_biotite_sequence()</strong> - Level 2: sequence-based alignment</li>
                <li><strong>_align_with_3di_structural()</strong> - Level 3: 3Di structural alignment</li>
                <li><strong>_align_with_centroid_fallback()</strong> - Level 4: centroid-based fallback</li>
            </ol>
            
            <h4>Helper Functions:</h4>
            <ol>
                <li><strong>_rmsd_from_alignment()</strong> - Extract anchors and perform superimposition</li>
                <li><strong>_validate_and_select_chains()</strong> - Validate chain selection</li>
                <li><strong>filter_amino_acids()</strong> - Filter protein structures</li>
                <li><strong>get_chains()</strong> - Extract chain information</li>
                <li><strong>to_sequence()</strong> - Convert structures to sequences</li>
                <li><strong>align_optimal()</strong> - Perform optimal alignment</li>
                <li><strong>rmsd()</strong> - Calculate RMSD</li>
            </ol>
            
            <h3>Workflow Features:</h3>
            <h4>Multi-Level Fallback Strategy:</h4>
            <ol>
                <li><strong>Level 1</strong>: Homologous alignment for similar-length sequences</li>
                <li><strong>Level 2</strong>: Sequence-based optimal alignment with anchor extraction</li>
                <li><strong>Level 3</strong>: 3Di structural alphabet alignment for remote homologs</li>
                <li><strong>Level 4</strong>: Simple centroid-based alignment as final fallback</li>
            </ol>
            
            <h4>Quality Control:</h4>
            <ul>
                <li><strong>CA RMSD Thresholds</strong>: Progressive fallback thresholds (10Å, 15Å, 20Å)</li>
                <li><strong>Anchor Count Validation</strong>: Minimum 3 anchors required</li>
                <li><strong>Bond Length Validation</strong>: Ensures reasonable molecular geometry</li>
                <li><strong>Chain Selection</strong>: Validates binding site chains from embedding data</li>
            </ul>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html> 